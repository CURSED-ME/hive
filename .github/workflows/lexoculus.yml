name: LexOculus Guardian

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  compliance-scan:
    name: EU AI Act Compliance Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Optical Audit Scan
        id: scan
        env:
          LEXOCULUS_API_URL: '${{ vars.LEXOCULUS_API_URL || 'https://compliance-ai-omega.vercel.app' }}'
          WEBHOOK_SECRET: ${{ secrets.LEXOCULUS_WEBHOOK_SECRET }}
          WEBHOOK_PAYLOAD: ${{ toJson(github.event) }}
        run: |
          # Write payload to file to avoid shell quoting issues with large JSON
          echo "$WEBHOOK_PAYLOAD" > payload.json

          # Calculate signature safely
          SIGNATURE=$(openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" payload.json | cut -d' ' -f2)

          # Send PR diff to LexOculus for optical analysis
          RESPONSE=$(curl -s -X POST \
            "$LEXOCULUS_API_URL/api/webhooks/github" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: pull_request" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            --data @payload.json)
          
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          
          # Parse risk from response
          RISK_LEVEL=$(echo $RESPONSE | jq -r '.risk_level // "MINIMAL_RISK"')
          BLOCKED=$(echo $RESPONSE | jq -r '.blocked // false')
          
          # Output summary to PR
          echo "## üëÅÔ∏è LexOculus Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "**Risk Level:** $RISK_LEVEL" >> $GITHUB_STEP_SUMMARY
          echo "**Blocked:** $BLOCKED" >> $GITHUB_STEP_SUMMARY
          
          if [ "$BLOCKED" = "true" ]; then
            echo "‚ùå PR blocked due to UNACCEPTABLE risk under EU AI Act"
            exit 1
          fi
